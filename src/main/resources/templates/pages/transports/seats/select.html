<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sélectionner un siège</title>
    <link th:href="@{/bs5.3/css/bootstrap.min.css}" rel="stylesheet" />
    <link th:href="@{/fa/css/all.min.css}" rel="stylesheet" />
    <style>
      .seat-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 15px;
        max-width: 800px;
        margin: 0 auto;
      }

      .seat {
        aspect-ratio: 1;
        border: 2px solid #333;
        background-color: #fff;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s;
        padding: 5px;
        text-align: center;
        position: relative;
      }

      .seat::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--seat-bg-color, #cccccc);
        opacity: 0.3;
        z-index: 0;
      }

      .seat > * {
        position: relative;
        z-index: 1;
      }

      .seat:hover:not(.occupied):not(.inactive) {
        border-color: #28a745;
        transform: scale(1.05);
      }

      .seat:hover:not(.occupied):not(.inactive)::before {
        opacity: 0.5;
      }

      .seat.available {
        border-color: #28a745;
      }

      .seat.occupied {
        color: #fff;
        border-color: #495057;
        cursor: not-allowed;
      }

      .seat.occupied::before {
        background-color: #6c757d !important;
        opacity: 0.9 !important;
      }

      .seat.occupied:hover {
        transform: none;
      }

      .seat.inactive {
        color: #000;
        border-color: #ff9800;
        cursor: not-allowed;
      }

      .seat.inactive::before {
        background-color: #ffc107 !important;
        opacity: 0.6 !important;
      }

      .seat.selected {
        border-color: #007bff !important;
        border-width: 3px;
      }

      .seat.selected::before {
        background-color: #007bff !important;
        opacity: 0.7 !important;
      }

      .seat-icon {
        font-size: 1.5rem;
        margin-bottom: 3px;
      }

      .seat-number {
        font-size: 1.1rem;
        font-weight: bold;
        margin-bottom: 3px;
      }

      .seat-passenger {
        font-size: 0.7rem;
        font-weight: normal;
        line-height: 1.1;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        line-clamp: 2;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
      }

      .legend {
        display: flex;
        gap: 30px;
        justify-content: center;
        margin-bottom: 30px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .legend-box {
        width: 30px;
        height: 30px;
        border: 2px solid #333;
      }

      .legend-box.available {
        background-color: #fff;
        border-color: #28a745;
      }

      .legend-box.occupied {
        background-color: #6c757d;
      }

      .legend-box.inactive {
        background-color: #ffc107;
        border-color: #ff9800;
      }

      .seat-type-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        justify-content: center;
        margin-top: 20px;
      }

      .seat-type-item {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .seat-type-color {
        width: 20px;
        height: 20px;
        border: 1px solid #333;
        border-radius: 3px;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid py-4">
      <div class="mb-4 d-flex justify-content-between align-items-center">
        <h4 class="mb-0">
          <i class="fa-solid fa-couch me-2"></i>
          Sélectionner <span id="modeText">un siège</span>
        </h4>
        <div id="multipleControls" style="display: none;">
          <button type="button" class="btn btn-primary" onclick="confirmSelection()">
            <i class="fa-solid fa-check me-1"></i>
            Confirmer (<span id="selectedCount">0</span>)
          </button>
        </div>
      </div>

      <!-- Légende -->
      <div class="card bg-white border-0 shadow-sm mb-4">
        <div class="card-body">
          <h6 class="mb-3">
            <i class="fa-solid fa-info-circle me-1"></i>
            État des sièges
          </h6>
          <div class="legend">
            <div class="legend-item">
              <div class="legend-box available"></div>
              <span>Disponible</span>
            </div>
            <div class="legend-item">
              <div class="legend-box occupied"></div>
              <span>Occupé</span>
            </div>
            <div class="legend-item">
              <div class="legend-box inactive"></div>
              <span>Inactif</span>
            </div>
          </div>

          <hr class="my-3" />

          <h6 class="mb-3">
            <i class="fa-solid fa-chair me-1"></i>
            Types de sièges
          </h6>
          <div class="seat-type-legend">
            <div class="seat-type-item" th:each="seatType : ${seatTypes}">
              <div class="seat-type-color" th:style="'background-color: ' + ${seatType.color}"></div>
              <span th:text="${seatType.name}">Standard</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Grille de sièges -->
      <div class="card bg-white border-0 shadow-sm">
        <div class="card-body p-4">
          <div class="seat-grid">
            <div
              th:each="seat : ${seats}"
              th:class="${!seat.available} ? 'seat inactive' : (${seatPassengerMap.containsKey(seat.id)} ? 'seat occupied' : 'seat available')"
              th:style="'--seat-bg-color: ' + ${seat.seatType != null ? seat.seatType.color : '#cccccc'}"
              th:title="'Siège ' + ${seat.seatNumber} + ' - ' + (${seat.seatType != null ? seat.seatType.name : 'Non défini'}) + ' - ' + (${!seat.available} ? 'Siège inactif' : (${seatPassengerMap.containsKey(seat.id)} ? ${seatPassengerMap.get(seat.id)} : 'Disponible'))"
              th:data-seat-id="${seat.id}"
              th:data-seat-number="${seat.seatNumber}"
              th:data-seat-price="${seatPriceMap.get(seat.id)}"
              th:data-occupied="${seatPassengerMap.containsKey(seat.id)}"
              th:data-active="${seat.available}"
              onclick="handleSeatClick(this)"
            >
              <div class="seat-icon" th:if="${!seat.available}">
                <i class="fa-solid fa-wrench"></i>
              </div>
              <div class="seat-icon" th:if="${seatPassengerMap.containsKey(seat.id)}">
                <i class="fa-solid fa-ban"></i>
              </div>
              <div class="seat-number" th:text="${seat.seatNumber}">A1</div>
              <div class="seat-passenger" th:if="${seatPassengerMap.containsKey(seat.id)}" th:text="${seatPassengerMap.get(seat.id)}">Passenger Name</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const multipleMode = urlParams.get('multiple') === 'true';
      let selectedSeats = [];

      // Initialize UI based on mode
      document.addEventListener('DOMContentLoaded', function() {
        if (multipleMode) {
          document.getElementById('modeText').textContent = 'des sièges (plusieurs)';
          document.getElementById('multipleControls').style.display = 'block';
        }
        
        // Pre-select seats if selectedIds parameter is present
        const selectedIds = urlParams.get('selectedIds');
        if (selectedIds && multipleMode) {
          const ids = selectedIds.split(',');
          ids.forEach(id => {
            const seatElement = document.querySelector(`[data-seat-id="${id}"]`);
            if (seatElement && 
                seatElement.getAttribute('data-occupied') !== 'true' && 
                seatElement.getAttribute('data-active') === 'true') {
              const number = seatElement.getAttribute('data-seat-number');
              const price = seatElement.getAttribute('data-seat-price');
              selectedSeats.push({
                id: id,
                number: number,
                price: parseFloat(price) || 0
              });
              seatElement.classList.add('selected');
            }
          });
          document.getElementById('selectedCount').textContent = selectedSeats.length;
        }
      });

      function handleSeatClick(element) {
        const isOccupied = element.getAttribute("data-occupied") === "true";
        const isActive = element.getAttribute("data-active") === "true";
        
        if (!isOccupied && isActive) {
          const id = element.getAttribute("data-seat-id");
          const number = element.getAttribute("data-seat-number");
          const price = element.getAttribute("data-seat-price");
          
          if (multipleMode) {
            toggleSeatSelection(element, id, number, price);
          } else {
            selectSeat(id, number, price);
          }
        }
      }

      function toggleSeatSelection(element, id, number, price) {
        const index = selectedSeats.findIndex(s => s.id === id);
        
        if (index > -1) {
          // Deselect
          selectedSeats.splice(index, 1);
          element.classList.remove('selected');
        } else {
          // Select
          selectedSeats.push({
            id: id,
            number: number,
            price: parseFloat(price) || 0
          });
          element.classList.add('selected');
        }
        
        document.getElementById('selectedCount').textContent = selectedSeats.length;
      }

      function confirmSelection() {
        if (selectedSeats.length === 0) {
          alert('Veuillez sélectionner au moins un siège');
          return;
        }
        
        if (window.opener) {
          window.opener.postMessage(
            {
              type: "selectSeats",
              seats: selectedSeats
            },
            "*"
          );
          window.close();
        }
      }

      function selectSeat(id, number, price) {
        // Send message to opener window (single mode)
        if (window.opener) {
          window.opener.postMessage(
            {
              type: "selectSeat",
              id: id,
              number: number,
              price: parseFloat(price) || 0,
            },
            "*"
          );
          window.close();
        }
      }
    </script>

    <script th:src="@{/bs5.3/js/bootstrap.bundle.min.js}"></script>
  </body>
</html>
