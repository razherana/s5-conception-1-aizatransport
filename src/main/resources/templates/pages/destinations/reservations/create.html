<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/app}"
>
  <head>
    <title>Nouvelle réservation</title>
    <th:block layout:fragment="script">
      <script>
        let selectedSeats = [];

        function openPassengerSelect() {
          const width = 900;
          const height = 600;
          const left = (screen.width / 2) - (width / 2);
          const top = (screen.height / 2) - (height / 2);
          window.open('/passengers/select?target=passengerInput', 'selectPassenger', 
            `width=${width},height=${height},top=${top},left=${left},scrollbars=yes`);
        }

        function openTripSelect() {
          const width = 900;
          const height = 600;
          const left = (screen.width / 2) - (width / 2);
          const top = (screen.height / 2) - (height / 2);
          window.open('/trips/select?target=tripInput', 'selectTrip', 
            `width=${width},height=${height},top=${top},left=${left},scrollbars=yes`);
        }

        function openSeatSelect() {
          const tripId = document.getElementById('tripId').value;
          if (!tripId) {
            alert('Veuillez sélectionner un voyage d\'abord');
            return;
          }
          const width = 900;
          const height = 600;
          const left = (screen.width / 2) - (width / 2);
          const top = (screen.height / 2) - (height / 2);
          window.open('/vehicles/seats/select?tripId=' + tripId + '&target=seatInput&multiple=true', 'selectSeat', 
            `width=${width},height=${height},top=${top},left=${left},scrollbars=yes`);
        }

        function removeSeat(seatId) {
          selectedSeats = selectedSeats.filter(s => s.id !== seatId);
          updateSeatsDisplay();
        }

        function updateSeatsDisplay() {
          const container = document.getElementById('selectedSeatsContainer');
          const hiddenContainer = document.getElementById('seatIdsContainer');
          
          if (selectedSeats.length === 0) {
            container.innerHTML = '<p class="text-muted mb-0"><i class="fa-solid fa-info-circle me-1"></i>Aucun siège sélectionné</p>';
            hiddenContainer.innerHTML = '';
          } else {
            let html = '<div class="d-flex flex-wrap gap-2">';
            selectedSeats.forEach(seat => {
              html += `
                <div class="badge bg-primary d-flex align-items-center gap-2" style="font-size: 0.9rem; padding: 0.5rem;">
                  <span><i class="fa-solid fa-couch me-1"></i>Siège ${seat.number}</span>
                  <button type="button" class="btn-close btn-close-white" style="font-size: 0.7rem;" onclick="removeSeat(${seat.id})" title="Retirer"></button>
                </div>
              `;
            });
            html += '</div>';
            container.innerHTML = html;
            
            // Add hidden inputs for seat IDs
            hiddenContainer.innerHTML = selectedSeats.map(seat => 
              `<input type="hidden" name="seatIds" value="${seat.id}" />`
            ).join('');
          }
          
          // Update the count
          document.getElementById('seatCount').textContent = selectedSeats.length;
        }

        window.addEventListener('message', function(event) {
          if (event.data.type === 'selectPassenger') {
            document.getElementById('passengerId').value = event.data.id;
            document.getElementById('passengerName').value = event.data.name;
          } else if (event.data.type === 'selectTrip') {
            document.getElementById('tripId').value = event.data.id;
            document.getElementById('tripInfo').value = event.data.info;
            // Auto-fill amount with route price if available
            if (event.data.price) {
              document.getElementById('amount').value = event.data.price;
            }
          } else if (event.data.type === 'selectSeat') {
            // Single seat (legacy)
            const seat = { id: event.data.id, number: event.data.number };
            if (!selectedSeats.find(s => s.id === seat.id)) {
              selectedSeats.push(seat);
              updateSeatsDisplay();
            }
          } else if (event.data.type === 'selectSeats') {
            // Multiple seats
            event.data.seats.forEach(seat => {
              if (!selectedSeats.find(s => s.id === seat.id)) {
                selectedSeats.push(seat);
              }
            });
            updateSeatsDisplay();
          }
        });

        // Initialize display on page load
        document.addEventListener('DOMContentLoaded', function() {
          updateSeatsDisplay();
        });
      </script>
    </th:block>
  </head>
  <body>
    <section layout:fragment="content" class="container py-4">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
          <i class="fa-solid fa-plus-circle me-2"></i>
          Nouvelle réservation
        </h1>
        <a th:href="@{/reservations}" class="btn btn-outline-secondary">
          <i class="fa-solid fa-arrow-left me-1"></i>
          Retour
        </a>
      </div>

      <!-- Formulaire -->
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="card bg-white border-0 shadow-sm">
            <div class="card-body p-4">
              <form th:action="@{/reservations/create}" th:object="${reservation}" method="post">
                <div class="row g-3">
                  <!-- Passager -->
                  <div class="col-md-12">
                    <label class="form-label">
                      Passager <span class="text-danger">*</span>
                    </label>
                    <div class="input-group">
                      <input type="hidden" id="passengerId" th:field="*{passenger.id}" required />
                      <input type="text" id="passengerName" class="form-control" placeholder="Cliquez pour sélectionner" readonly required />
                      <button type="button" class="btn btn-outline-primary" onclick="openPassengerSelect()">
                        <i class="fa-solid fa-search"></i> Sélectionner
                      </button>
                    </div>
                  </div>

                  <!-- Voyage -->
                  <div class="col-md-12">
                    <label class="form-label">
                      Voyage <span class="text-danger">*</span>
                    </label>
                    <div class="input-group">
                      <input type="hidden" id="tripId" th:field="*{trip.id}" required />
                      <input type="text" id="tripInfo" class="form-control" placeholder="Cliquez pour sélectionner" readonly required />
                      <button type="button" class="btn btn-outline-primary" onclick="openTripSelect()">
                        <i class="fa-solid fa-search"></i> Sélectionner
                      </button>
                    </div>
                  </div>

                  <!-- Sièges (Multiple) -->
                  <div class="col-md-12">
                    <label class="form-label">
                      Sièges <span class="text-danger">*</span>
                      <span class="badge bg-secondary ms-2" id="seatCount">0</span>
                    </label>
                    <div class="border rounded p-3 mb-2" style="min-height: 80px; background-color: #f8f9fa;">
                      <div id="selectedSeatsContainer">
                        <p class="text-muted mb-0"><i class="fa-solid fa-info-circle me-1"></i>Aucun siège sélectionné</p>
                      </div>
                    </div>
                    <div id="seatIdsContainer">
                      <!-- Hidden inputs for seat IDs will be added here -->
                    </div>
                    <button type="button" class="btn btn-outline-primary w-100" onclick="openSeatSelect()">
                      <i class="fa-solid fa-couch me-1"></i> Sélectionner des sièges
                    </button>
                    <small class="form-text text-muted">
                      Vous pouvez sélectionner plusieurs sièges. Une réservation sera créée pour chaque siège.
                    </small>
                  </div>

                  <!-- Montant -->
                  <div class="col-md-6">
                    <label for="amount" class="form-label">
                      Montant (Ar) <span class="text-danger">*</span>
                    </label>
                    <input type="number" class="form-control" id="amount" th:field="*{amount}" required min="0" step="100" placeholder="Ex: 15000" />
                  </div>

                  <!-- Statut -->
                  <div class="col-md-6">
                    <label for="status" class="form-label">
                      Statut <span class="text-danger">*</span>
                    </label>
                    <select class="form-select" id="status" th:field="*{status}" required>
                      <option value="">Sélectionner un statut</option>
                      <option th:each="status : ${statuses}" th:value="${status}" th:text="${status}"></option>
                    </select>
                  </div>

                  <div class="col-12">
                    <hr class="my-3" />
                    <div class="d-flex justify-content-end gap-2">
                      <a th:href="@{/reservations}" class="btn btn-outline-secondary">
                        <i class="fa-solid fa-times me-1"></i>
                        Annuler
                      </a>
                      <button type="submit" class="btn btn-primary">
                        <i class="fa-solid fa-save me-1"></i>
                        Enregistrer
                      </button>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>
  </body>
</html>
