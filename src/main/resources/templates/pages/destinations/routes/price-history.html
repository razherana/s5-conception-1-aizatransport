<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/app}"
>
  <head>
    <title>Historique des prix</title>
  </head>
  <body>
    <section layout:fragment="content" class="container-fluid py-4">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
          <i class="fa-solid fa-chart-line me-2"></i>
          Historique des prix
        </h1>
        <a th:href="@{/routes}" class="btn btn-outline-secondary">
          <i class="fa-solid fa-arrow-left me-1"></i>
          Retour aux routes
        </a>
      </div>

      <!-- Messages flash -->
      <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fa-solid fa-check-circle me-2"></i>
        <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
      <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fa-solid fa-exclamation-circle me-2"></i>
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>

      <!-- Route Info -->
      <div class="card mb-4 bg-white border-0 shadow-sm">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h5 class="mb-2">
                <i class="fa-solid fa-map-marker-alt text-success me-2"></i>
                <span th:text="${route.departureDestination.name}">Antananarivo</span>
                <i class="fa-solid fa-arrow-right mx-3"></i>
                <i class="fa-solid fa-map-marker-alt text-danger me-2"></i>
                <span th:text="${route.arrivalDestination.name}">Toamasina</span>
              </h5>
              <p class="mb-0 text-muted">
                <span th:if="${route.distanceKm != null}">
                  <i class="fa-solid fa-road me-1"></i>
                  Distance: <strong th:text="${route.distanceKm} + ' km'">365 km</strong>
                </span>
              </p>
            </div>
            <div class="col-md-4 text-end">
              <div class="h4 mb-0">
                Prix actuel: 
                <span class="badge bg-success fs-5" th:text="${#numbers.formatDecimal(currentPrice, 1, 'COMMA', 2, 'POINT')} + ' Ar'">
                  50,000.00 Ar
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <!-- Chart -->
        <div class="col-lg-8">
          <div class="card bg-white border-0 shadow-sm mb-4">
            <div class="card-header bg-light border-0 d-flex justify-content-between align-items-center">
              <h5 class="mb-0">
                <i class="fa-solid fa-chart-area me-2"></i>
                Évolution des prix
              </h5>
              <div class="d-flex gap-2">
                <select id="chartSeatTypeFilter" class="form-select" style="width: auto; max-width: 250px;">
                  <option value="" disabled selected>Sélectionner un type de siège...</option>
                  <option th:each="seatType : ${seatTypes}" th:value="${seatType.id}" th:text="${seatType.name}">Standard</option>
                </select>
              </div>
            </div>
            <div class="card-body">
              <canvas id="priceChart" height="100"></canvas>
            </div>
          </div>

          <!-- Price History Table -->
          <div class="card bg-white border-0 shadow-sm">
            <div class="card-header bg-light border-0 d-flex justify-content-between align-items-center">
              <h5 class="mb-0">
                <i class="fa-solid fa-history me-2"></i>
                Historique complet
              </h5>
              <div class="d-flex gap-2">
                <select id="tripTypeFilter" class="form-select" style="width: auto; max-width: 200px;">
                  <option value="all">Tous les trajets</option>
                  <option th:each="tripType : ${tripTypes}" th:value="${tripType.id}" th:text="${tripType.name}">Express</option>
                </select>
                <select id="seatTypeFilter" class="form-select" style="width: auto; max-width: 200px;">
                  <option value="all">Tous les sièges</option>
                  <option th:each="seatType : ${seatTypes}" th:value="${seatType.id}" th:text="${seatType.name}">Standard</option>
                </select>
              </div>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover align-middle" id="priceHistoryTable">
                  <thead class="table-light">
                    <tr>
                      <th>Date d'effet</th>
                      <th>Type de trajet</th>
                      <th>Type de siège</th>
                      <th>Prix (Ar)</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr th:if="${#lists.isEmpty(priceHistoryDTOs)}">
                      <td colspan="4" class="text-center text-muted py-4">
                        <i class="fa-solid fa-inbox fa-2x mb-2 d-block"></i>
                        Aucun historique de prix
                      </td>
                    </tr>
                    <tr th:each="priceDTO : ${priceHistoryDTOs}" 
                        th:data-trip-type-id="${priceDTO.tripTypeId}"
                        th:data-seat-type-id="${priceDTO.seatTypeId}">
                      <td>
                        <i class="fa-solid fa-calendar me-2"></i>
                        <span th:text="${#temporals.format(priceDTO.effectiveDate, 'dd/MM/yyyy')}">01/01/2026</span>
                        <span th:if="${priceDTO.current}" class="badge bg-primary ms-2">Actuel</span>
                      </td>
                      <td>
                        <span class="badge bg-info" th:text="${priceDTO.tripTypeName}">Express</span>
                        <span th:if="${!priceDTO.tripTypeActive}" class="badge bg-warning ms-1">
                          <i class="fa-solid fa-exclamation-triangle"></i> Inactif
                        </span>
                      </td>
                      <td>
                        <span class="badge" 
                              th:style="'background-color: ' + ${priceDTO.seatTypeColor} + '; color: white;'"
                              th:text="${priceDTO.seatTypeName}">Standard</span>
                      </td>
                      <td>
                        <strong th:text="${#numbers.formatDecimal(priceDTO.price, 1, 'COMMA', 2, 'POINT')} + ' Ar'">50,000.00 Ar</strong>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Add Price Form -->
        <div class="col-lg-4">
          <div class="card bg-white border-0 shadow-sm sticky-top" style="top: 4em; z-index: 10;">
            <div class="card-header bg-primary text-white border-0">
              <h5 class="mb-0">
                <i class="fa-solid fa-plus-circle me-2"></i>
                Ajouter un nouveau prix
              </h5>
            </div>
            <div class="card-body p-4">
              <form th:action="@{/routes/{id}/add-price(id=${route.id})}" method="post">
                <div class="mb-3">
                  <label for="tripTypeId" class="form-label">
                    Type de trajet <span class="text-danger">*</span>
                  </label>
                  <select
                    class="form-select"
                    id="tripTypeId"
                    name="tripTypeId"
                    required
                    th:attr="data-classique-id=${classiqueId}"
                  >
                    <option value="" disabled>Sélectionner un type de trajet...</option>
                    <option th:each="tripType : ${tripTypes}" 
                            th:value="${tripType.id}" 
                            th:text="${tripType.name}"
                            th:selected="${tripType.id == classiqueId}">Express</option>
                  </select>
                  <div class="form-text">
                    Sélectionnez le type de trajet auquel ce prix s'applique
                  </div>
                </div>

                <div class="mb-3">
                  <label for="seatTypeId" class="form-label">
                    Type de siège <span class="text-danger">*</span>
                  </label>
                  <select
                    class="form-select"
                    id="seatTypeId"
                    name="seatTypeId"
                    required
                  >
                    <option value="" disabled selected>Sélectionner un type de siège...</option>
                    <option th:each="seatType : ${seatTypes}" 
                            th:value="${seatType.id}" 
                            th:text="${seatType.name}"
                            th:style="'background-color: ' + ${seatType.color} + '; color: white;'">Standard</option>
                  </select>
                  <div class="form-text">
                    Sélectionnez le type de siège auquel ce prix s'applique
                  </div>
                </div>

                <div class="mb-3">
                  <label for="price" class="form-label">
                    Prix (Ar) <span class="text-danger">*</span>
                  </label>
                  <input
                    type="number"
                    step="0.01"
                    class="form-control"
                    id="price"
                    name="price"
                    required
                    placeholder="Ex: 55000.00"
                  />
                  <div class="form-text">
                    Prix actuel: <strong id="currentPriceText">Sélectionnez un type de trajet et un type de siège</strong>
                  </div>
                </div>

                <div class="mb-3">
                  <label for="effectiveDate" class="form-label">
                    Date d'effet <span class="text-danger">*</span>
                  </label>
                  <input
                    type="date"
                    class="form-control"
                    id="effectiveDate"
                    name="effectiveDate"
                    required
                    th:value="${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd')}"
                  />
                  <div class="form-text">
                    La date à partir de laquelle ce prix sera effectif
                  </div>
                </div>

                <div class="alert alert-warning small">
                  <i class="fa-solid fa-exclamation-triangle me-2"></i>
                  Ce nouveau prix sera ajouté pour la combinaison type de trajet + type de siège sélectionnée. Les anciens prix seront conservés.
                </div>

                <button type="submit" class="btn btn-primary w-100">
                  <i class="fa-solid fa-save me-1"></i>
                  Enregistrer le prix
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Chart.js Script -->
    <th:block layout:fragment="script-bottom">
      <script th:inline="javascript">
        /*<![CDATA[*/
        const chartLabels = /*[[${chartData.labels}]]*/ [];
        const chartPrices = /*[[${chartData.prices}]]*/ [];
        const chartTripTypeIds = /*[[${chartData.tripTypeIds}]]*/ [];
        const chartSeatTypeIds = /*[[${chartData.seatTypeIds}]]*/ [];
        const classiqueId = /*[[${classiqueId}]]*/ null;
        const pricesByCombo = /*[[${pricesByCombo}]]*/ {};

        let priceChart = null;

        function updateChart(seatTypeId) {
          if (!seatTypeId) {
            // Clear chart if no seat type selected
            if (priceChart) {
              priceChart.destroy();
              priceChart = null;
            }
            return;
          }

          // Filter data for Classique trip type and selected seat type
          const filteredData = chartLabels.reduce((acc, label, index) => {
            if (chartTripTypeIds[index] === classiqueId && chartSeatTypeIds[index] == seatTypeId) {
              acc.labels.push(label);
              acc.prices.push(chartPrices[index]);
            }
            return acc;
          }, { labels: [], prices: [] });

          // Get seat type name for label
          const seatTypeSelect = document.getElementById('chartSeatTypeFilter');
          const seatTypeName = seatTypeSelect.options[seatTypeSelect.selectedIndex].text;

          // Destroy existing chart
          if (priceChart) {
            priceChart.destroy();
          }

          // Create the chart with filtered data
          const ctx = document.getElementById('priceChart').getContext('2d');
          priceChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: filteredData.labels,
              datasets: [{
                label: 'Prix (Ar) - Classique - ' + seatTypeName,
                data: filteredData.prices,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.3,
                fill: true,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: 'rgb(75, 192, 192)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  display: true,
                  position: 'top'
                },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      return 'Prix: ' + context.parsed.y.toLocaleString('fr-FR', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                      }) + ' Ar';
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: false,
                  ticks: {
                    callback: function(value) {
                      return value.toLocaleString('fr-FR') + ' Ar';
                    }
                  }
                },
                x: {
                  grid: {
                    display: false
                  }
                }
              }
            }
          });
        }

        // Filter price history by trip type and seat type
        function filterTable() {
          const tripTypeValue = document.getElementById('tripTypeFilter').value;
          const seatTypeValue = document.getElementById('seatTypeFilter').value;
          const tableRows = document.querySelectorAll('#priceHistoryTable tbody tr:not(:first-child)');
          
          tableRows.forEach(row => {
            const tripTypeId = row.getAttribute('data-trip-type-id');
            const seatTypeId = row.getAttribute('data-seat-type-id');
            
            const tripTypeMatch = tripTypeValue === 'all' || tripTypeId === tripTypeValue;
            const seatTypeMatch = seatTypeValue === 'all' || seatTypeId === seatTypeValue;
            
            if (tripTypeMatch && seatTypeMatch) {
              row.style.display = '';
            } else {
              row.style.display = 'none';
            }
          });
        }

        // Update price input based on selected trip type and seat type
        function updateCurrentPrice() {
          const tripTypeId = document.getElementById('tripTypeId').value;
          const seatTypeId = document.getElementById('seatTypeId').value;
          
          if (tripTypeId && seatTypeId) {
            const key = tripTypeId + '_' + seatTypeId;
            const currentPrice = pricesByCombo[key];
            
            const priceInput = document.getElementById('price');
            const priceText = document.getElementById('currentPriceText');
            
            if (currentPrice) {
              priceInput.value = currentPrice;
              priceText.textContent = parseFloat(currentPrice).toLocaleString('fr-FR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
              }) + ' Ar';
            } else {
              priceInput.value = '';
              priceText.textContent = 'Aucun prix configuré';
            }
          }
        }

        // Set Classique as default and apply initial filter
        document.addEventListener('DOMContentLoaded', function() {
          if (classiqueId) {
            document.getElementById('tripTypeFilter').value = classiqueId;
            document.getElementById('tripTypeId').value = classiqueId;
            filterTable();
          }
        });

        document.getElementById('tripTypeFilter').addEventListener('change', filterTable);
        document.getElementById('seatTypeFilter').addEventListener('change', filterTable);
        document.getElementById('chartSeatTypeFilter').addEventListener('change', function() {
          updateChart(this.value);
        });
        document.getElementById('tripTypeId').addEventListener('change', updateCurrentPrice);
        document.getElementById('seatTypeId').addEventListener('change', updateCurrentPrice);
        /*]]>*/
      </script>
    </th:block>
  </body>
</html>
